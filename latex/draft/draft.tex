\documentclass[12pt]{article}

% Packages
\usepackage{lmodern}
\usepackage{amsmath} % For mathematical symbols and equations
\usepackage{graphicx} % For including figures
\usepackage{hyperref} % For hyperlinks
\usepackage{listings} % Required for inserting code snippets
\usepackage{xcolor} % Required for custom colors
\usepackage[margin=1in]{geometry}
\usepackage{titling}
\usepackage{setspace}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{enumitem}

\lstset{
    language=R, % Set the language for code snippets to R
    basicstyle=\ttfamily\small, % Set the font and size for code snippets
    commentstyle=\color{green!60!black}, % Set the color for comments
    stringstyle=\color{orange}, % Set the color for strings
    showstringspaces=false, % Don't show spaces in strings
    breaklines=true, % Allow code to break across lines
    frame=single, % Add a frame around code snippets
    numbers=left, % Add line numbers to code snippets
    numberstyle=\tiny\color{gray}, % Set the style for line numbers
    captionpos=b,
	xleftmargin=0cm,
}

% Title and author
\title{Title}
\author{Leo Kraushaar \& Ali Hay \\ STAT 413}
\date{\today}

\begin{document}
\onehalfspacing

\begin{titlepage}
  \newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
  \center

  \HRule \\[1cm]
  { \huge \bfseries \thetitle}\\[0.4cm]
  \HRule \\[1.8cm]

  \Large \thedate\\[5cm]

  \begin{minipage}{1\textwidth}
    \vspace{10cm}
    \begin{flushleft} \large
      \theauthor
    \end{flushleft}

  \end{minipage}
\end{titlepage}

\newpage
\section{Introduction}
For this project, we are working with a data set containing the number of protests each month from January 2022 until November 2023 in every Canadian province and territory.

Our dataset contained the population size of each province in each month. We also thought it might be interesting to consider the state of the economy in each month over our timeframe, since this could affect how happy individuals are, which could perhaps influence how likely they are to participate in protests. For this reason, we decided to collect some extra data related to economic factors: oil imports in cubic meters, total power generated in megawatt hours, and total retail sales in thousands of dollars.

Our goal in this project is to model the number of protests using our data. Next, we use our model to create confidence intervals, with different bootstrapping methods to determine the most significant parameters in our model. Finally, we use Monte Carlo simulation to create prediction intervals for the monthly number of protests in each province and territory based on projections for model parameters that we simulated for the year 2030.

With our dataset, we decided to fit a Negative Binomial Model, as this is an effective model for count data able to accomodate overdispersion. We decided to combine the months into four seasons, as this improved the fit of our model. After fitting our initial model, via stepwise selection, we found season, retail, and province to be significant. We additionally compared these results against resampling bootstrapping, parametric bootstrapping, smooth bootstrapping and error-sampling bootstrapping to create 95\% confidence intervals for identifying which of the model parameters were most significant. Lastly, we used Monte Caro methods to create 95\% prediction intervals for the median number of protests in each Canadian province and territory based on our projected retail sales in the year 2030. We created these retail sales projections using more data on the total retail sales as discussed in later sections of this report.
Our main algorithms and results are given, summarized, and analyzed throughout this report.

\newpage
\section{Model Building}
\textcolor{red}{fix table}\\
For this project, we decided to use a Negative Binomial Generalized Linear Regression Model (glm),

(Fig. 1), as this model works well to model count data, even with over/under-dispersed responses. We initially fit our model using the predictors \textbf{year, season, province, population, retail, oil, and power}. We standardized the retail predictor before fitting the model, as it was on a much larger scale than the other predictors. We also combined the months into four seasons, as this reduced the standard error of the maximum likelihood estimate of the model's dispersion parameter. Using a stepwise selection method in R, set to minimize model AIC, we created our final model, which contained the significant predictors of season, province, and retail. Below is the R output of the final model.
\begin{verbatim}
Call:
glm.nb(formula = protests ~ season + prov + retail, data = data, 
    init.theta = 8.30561596, link = log)

Coefficients:
                              Estimate Std. Error z value Pr(>|z|)    
(Intercept)                    3.68364    0.50985   7.225 5.01e-13 ***
seasonSpring                  -0.06502    0.08264  -0.787 0.431441    
seasonSummer                  -0.55217    0.08629  -6.399 1.57e-10 ***
seasonWinter                  -0.22871    0.08873  -2.578 0.009946 ** 
provBritish Columbia           0.81551    0.16310   5.000 5.73e-07 ***
provManitoba                  -1.91505    0.92108  -2.079 0.037605 *  
provNew Brunswick             -2.62399    1.04409  -2.513 0.011965 *  
provNewfoundland and Labrador -3.06967    1.11340  -2.757 0.005833 ** 
provNorthwest Territories     -5.35839    1.26866  -4.224 2.40e-05 ***
provNova Scotia               -2.41344    0.99351  -2.429 0.015133 *  
provNunavut                   -4.98454    1.26290  -3.947 7.92e-05 ***
provOntario                    5.59695    2.44944   2.285 0.022314 *  
provPrince Edward Island      -4.11279    1.21600  -3.382 0.000719 ***
provQuebec                     2.19032    0.93156   2.351 0.018711 *  
provSaskatchewan              -2.58187    0.94178  -2.741 0.006116 ** 
provYukon                     -4.13848    1.24460  -3.325 0.000884 ***
retail                        -1.85334    1.06448  -1.741 0.081671 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for Negative Binomial(8.3056) family taken to be 1)

    Null deviance: 2091.2  on 298  degrees of freedom
Residual deviance:  349.2  on 282  degrees of freedom
AIC: 1585

Number of Fisher Scoring iterations: 1


              Theta:  8.31 
          Std. Err.:  1.46 

  2 x log-likelihood:  -1548.997 
\end{verbatim}


\begin{figure}[h!]
  \centering
  \fbox{
    \includegraphics[width=0.5\textwidth]{images/histogram.png}
  }
  \caption{Histogram of Protests}
  \label{fig:your_label}
\end{figure}

\newpage
\section{Bootstrapping for Feature Significance}
\subsection{Resampling Bootstrap}
\subsubsection*{Procedure}
Using $B = 10000$, an algorithm was written to perform a resampling bootstrap on the dataset. On each iteration, a sample of size $n$ (where $n$ was the number of rows in the dataset) was taken with replacement. Using this sample, a new model was fit and the parameter estimates were recorded. Relevant code is shown below.

\vspace{1cm}
\begin{lstlisting}[language=R]
resampBoot <- function(df, B) {
	# Get sample size
	n <- nrow(df)
	# Initialize empty dataframe
	params <- c()
	# Initialize progress bar
	bar <- txtProgressBar(min=0, max=B, style=1)
	# Perform B iterations
	for (b in 1:B) {
		# Select a sample of size n
		indices <- sample(1:n, replace = TRUE)
		samp <- df[indices, ]
		# Fit the model with the sample
		boot_model <- glm.nb(protests ~., data=samp, init.theta = 10)
		boot_params <- coef(boot_model)
		params <- rbind(params, boot_params)
		setTxtProgressBar(bar, b)
	}
	close(bar)
	return(params)
}
\end{lstlisting}

\subsubsection*{Results}
We used the resampling bootstrap techniques to test whether there was a significant difference in the mean number of protests in each of the different seasons. Our baseline season was fall. The 95\% confidence interval for the spring coefficient did contain 0, but the 95\% confidence intervals for each of the summer and the winter coefficients did not. This tells us that the log mean number of protests in the spring is not significantly different in the spring than the fall, but the log mean number of protests in both the summer and the winter is significantly different than in the fall. Since each of the coefficients for summer and winter are negative, that tells us that there are less protests in both the summer and the winter than there are in the fall.

When using the resampling bootstrap to test for a significant difference in the mean number of protests in each of the different provinces, our baseline province was Alberta. Here, the 95\% confidence intervals for each province and territory showed us that the mean number of protests were significantly different from that of Alberta. British Columbia, Ontario, and Quebec each had a larger mean number of protests than Alberta, whereas the other provinces and territories all had a lower mean number of protests than Alberta.
Using the resampling bootstrapping techniques, the 95\% confidence interval for the coefficient on retail showed us that retail did not have a significant effect on the mean number of protests.

\input{tables/resamp.tex}

\newpage
\subsection{Parametric Bootstrap}
\subsubsection*{Procedure}
Using $B = 10000$, an algorithm was written to perform a parametric bootstrap on the dataset.

Using the estimated dispersion parameter $\theta \approx 8.31$, each iteration sampled a random vector from a negative binomial distribution. The distribution had dispersion parameter $\theta$ and mean $\hat y$, where $\hat y$ was the predicted mean value for the corresponding input values.

From the new estimates, a model was fit on each iteration and the parameter estimates were recorded. Relevant code is shown below.

\begin{lstlisting}
conditionalNegBinom <- function(theta, mu) {
    nb_sample <- rnbinom(size=theta, mu=mu, n=1)
    return(nb_sample)
}

paramBoot <- function(B, X, yhat, theta, func) {

    # Initialize empty vector
    params <- c()
    # Iterate B times
    for (b in 1:B) {
        # Simulate NB given means
        sim_y <- sapply(yhat, function(y) func(theta, y))
        # Add to the dataframe
        sim_data <- cbind(X, protests=sim_y)
        # Fit the model to the simulated data
        sim_model <- glm.nb(protests ~., data=sim_data, init.theta = theta)
        # Access the coefficients and store
        parameters <- coef(sim_model)
        params <- rbind(params, parameters)
    }
    return(params)
}
\end{lstlisting}
\subsubsection*{Results}
When using parametric bootstrapping techniques, we came to exactly the same conclusions as we did when using the resampling bootstrapping method. Comparing the widths of these intervals for the seasons with the resampling bootstrap intervals, we found that they were compareable. For the provinces, some of these confidence intervals were wider than the resampling bootstrap intervals, whereas some were narrower. The confidence intervals for retail had a similar standard error.

\input{tables/param.tex}

\subsection{Smooth Bootstrap}
The smooth bootstrap is not an ``ideal'' method for the given dataset, as only one predictor \textbf{(retail)} was continuous and real-valued. However, results were consistent with other methods, as discussed later.

Again using $B = 10000$, an algorithm was written to perform a smooth bootstrap. The \textbf{retail} column was found to have a sample variance of 1, due to the fact that it was standardized prior to model building. A reasonable value for the noise term was chosen, that is, $\frac{1}{\sqrt{n}} \approx 0.05783$. On each iteration, some $\varepsilon_i$ was added to the $i$'th value of retail, where $\varepsilon \sim N(0, 0.05783)$. Using this ``new'' dataset, a model was fit and the paramter estimates were recorded. Relevant code is shown below.

\subsubsection*{Procedure}
\begin{lstlisting}
addNoise <- function(X) {

    cols <- colnames(X)
    new_X <- X
    for (col in cols) {
        Xi <- X[, col]
        if (class(data[, col]) != "factor") {
            n <- length(Xi)
            S_sq <- var(Xi)
            noise_var <- S_sq / n
            new_X[, col] <- Xi + rnorm(n=n, mean=0, sd=sqrt(noise_var))
        } else {
            new_X[, col] <- Xi
        }
    }
    return(new_X)
}

smoothBoot <- function(X, y, B, noisefunc) {

    # Get sample size
    n <- nrow(X)
    # Initialize empty vector
    params <- c()
    
    # Initialize progress bar
    pb <- txtProgressBar(min = 0, max = B, style = 3)
    
    # Perform B iterations
    for (b in 1:B) {
        # Update progress bar
        setTxtProgressBar(pb, b)
        
        # Get new dataset
        new_X <- noisefunc(X)
        new_data <- data.frame(protests=y, new_X)
        
        # Fit the model with the simulated data
        smoothboot_model <- glm.nb(protests ~., data=new_data, init.theta = 5)
        boot_params <- coef(smoothboot_model)
        params <- rbind(params, boot_params)
    }
    
    # Close progress bar
    close(pb)
    
    return(params)
}
\end{lstlisting}
\subsubsection*{Results}
When using smooth bootstrapping techniques, the results of our 95\% confidence intervals yielded similar conclusions to that of the first two methods, but there were some differences. This method showed us that the mean number of protests was significantly lower in each of the other three seasons than in the fall.
Additionally, using smooth bootstrapping techniques did also lead us to slightly different conclusions when comparing the mean number of protests in each of the provinces and territories. Here we found that each province, except for Manitoba, had a significantly different mean number of protests than Alberta. Again, British Columbia, Ontario and Quebec had more mean protests than Alberta, whereas each of the others had less.
This method also showed us that retail did not have a significant effect on the mean number of protests.

\input{tables/smooth.tex}

\subsection{Error-Sampling Bootstrap}
Another bootstrap method was implemented, in which the error terms from the fitted model were randomly sampled with replacement, and added to the fitted values. Notably, some resulting simulated counts were rounded up to zero in the case where a negative value was produced. This was required both logically; as protests counts cannot be negative, and mathematically; as the negative binomial glm cannot be fit with negative training outputs. As a result, the integrity of the simulated datasets was not assumed to be completely intact, the implications of which are discussed later.

\subsubsection*{Procedure}

\begin{lstlisting}
epsilonBoot <- function(X, model, B, errors) {

    # Get sample size
    n <- nrow(X)
    # Initialize empty vector
    params <- c()
    # Perform B iterations
    for (b in 1:B) {
        # Get errors
        errs <- sample(errors, size=n, replace=TRUE)
        # Get fitted values
        yhat <- fitted(model)
        # Get simulated y
        ystar <- yhat + errs
        # round up negative values
        ystar <- pmax(rep(0, n), ystar)
        # Turn into DataFrame
        sim_data <- data.frame(protests=ystar, X)
        # Fit the model with the simulated data
        paramboot_model <- glm.nb(protests ~., data=sim_data, init.theta = 5)
        boot_params <- coef(paramboot_model)
        params <- rbind(params, boot_params)
    }
    return(params)
}
\end{lstlisting}
\subsubsection*{Results}
Using the error-sampling bootstrap techniques also produced 95\% confidence intervals that led to slightly different conclusions than the other methods. As with the smooth bootstrapping technique, this method showed us that the mean number of protests was significantly lower in each of the other three seasons than in the fall.
When comparing the mean number of protests in each of the Canadian provinces and territories, we came to the same conclusions using this method as we did with the resampling and parametric bootstraps.
Unlike the other three bootstrapping methods, however, our 95\% confidence interval using the error-sampling bootstrapping showed us that the retail sales did have a significantly negative effect on the mean number of protests. Because of this inconsistency, a natural inference is that the error-sampling bootstrap, at least in this implementation, relies too much on to the validity of the model.

\input{tables/error.tex}

\subsection{Method Comparison}
Using the different Bootstrapping techniques did yield similar conclusions. However, there were a few differences (as mentioned before). We can see from the Z-scores based on the resampling bootstrap that parameters with the highest absolute value of Z-score were summer, followed by British Columbia, then the Northwest Territories, telling us that these were the most significant parameters in our model. The parametric bootstrapping method yielded the same top three most significant parameters as the resampling method. With the smooth bootstrapping method, summer was again the most significant parameter. However it was followed by winter and subsequently British Columbia. Finally, using error-sampling bootstrapping, British Columbia was the most significant parameter, followed by Summer, and then Saskatchewan. Using the error-sampling technique, our Z-scores were much higher in absolute value than the other methods, although smooth bootstrapping did produce some high Z-scores.
Each of our bootstrapping methods produced similar results, with the resampling method and the parametric being the most similar, and the error-sampling method the most different from the other three.

\newpage
\section{Monte Carlo Estimation}
\subsection*{Methods}
Using observations of \textbf{retail} from 2017 to 2022, we fit a linear model predicting the total retail sales using a stepwise selection method using province, year, and season.

We used this model to create 95\% prediction intervals for the retail sales in each province for every month in the year 2030. Normally across these intervals, we randomly sampled values to use as the projected retail sales. For each of these projected retail sales, we sampled from our negative binomial model to predict each province's total protests each season. Combining the seasons, we predicted the median number of protests in each Canadian province and territory based on our projected retail sales with 95\% prediction intervals.

\begin{lstlisting}
num_iterations <- 10000
results <- c()

for (i in 1:num_iterations) {

	blank_data <- data[as.character(data$year) == "2023", ][, c(-3)]

	blank_data$year <- 2030
	# Predict retail uniformly from interval
	blank_data <- cbind(blank_data, predict.lm(retail_predictor, newdata=blank_data, interval = "prediction"))
	blank_data <- as.data.frame(blank_data)
	pred_retails <- runif(n=nrow(blank_data), min=blank_data$lwr, max=blank_data$upr)
	
	blank_data$retail <- pred_retails
	blank_data[, c("fit", "lwr", "upr")] <- NULL
	blank_data$year <- NULL
	
	# Predict protests
	blank_data$protests <- predict.glm(model, newdata=blank_data, type="response")
	# Round off to nearest integer
	blank_data$protests <- round(blank_data$protests)

	rownames(blank_data) <- NULL
	results <- rbind(results, blank_data)
}
\end{lstlisting}

\subsection*{Results}
Here we compare 95\% Monte Carlo prediction intervals with the observed number of protests in each province during the year 2023. Each of the confidence intervals, except for Quebec and Ontario, are entirely below the observed number of protests in 2023. This is to be expected as total retail sales have a negative association with number of protests, which we can see from the negative estimate of the parameter, meaning that as the total retail sales increase, the number of protests is expected to decrease. In 2030, it is expected that the total retail sales will increase, so this increase in retail sales explains the typical predicted decrease in protests. The lack of decrease in protests in Ontario and Quebec could have been due to random variation in the number of protests in 2023. For example Ontario and Quebec may have had a large number of protests in that year.


\begin{table}[hbt!]
  \centering
  \begin{tabular}{|l|c|c|c|c|c|c|c|}
    \hline
    \textbf{prov}             & \textbf{2023} & \textbf{2.5\%} & \textbf{50\%} & \textbf{97.5\%} & \textbf{pred.effect} & \textbf{sig.effect} \\

    \hline
    Alberta                   & 139           & 103            & 116           & 131             & dec.                 & Y                   \\
    British Columbia          & 284           & 193            & 218           & 245             & dec.                 & Y                   \\
    Manitoba                  & 118           & 63             & 71            & 81              & dec.                 & Y                   \\
    New Brunswick             & 61            & 37             & 42            & 48              & dec.                 & Y                   \\
    Newfoundland and Labrador & 61            & 26             & 30            & 34              & dec.                 & Y                   \\
    Northwest Territories     & 6             & 0              & 0             & 2               & dec.                 & Y                   \\
    Nova Scotia               & 85            & 43             & 48            & 55              & dec.                 & Y                   \\
    Nunavut                   & 11            & 3              & 5             & 7               & dec.                 & Y                   \\
    Ontario                   & 627           & 668            & 755           & 849             & inc.                 & Y                   \\
    Prince Edward Island      & 29            & 11             & 12            & 15              & dec.                 & Y                   \\
    Quebec                    & 270           & 250            & 282           & 317             & inc.                 & N                   \\
    Saskatchewan              & 56            & 33             & 38            & 43              & dec.                 & Y                   \\
    Yukon                     & 18            & 11             & 12            & 15              & dec.                 & Y                   \\
    \hline
  \end{tabular}
  \caption{95\% Prediction Intervals for Total Yearly Protests by Province, 2030}
\end{table}

\newpage
\section{Conclusion}
For this project we fit a Negative Binomial Generalized Linear Regression Model including the predictors season, retail, and province. We used this model to perform resampling bootstrapping, parametric bootstrapping, smooth bootstrapping and error-sampling bootstrapping to create 95\% confidence intervals. In all four cases, summer and British Columbia were in the top three most significant parameters. Finally, we created projections for retail sales in 2030 and used these to create 95\% Monte Carlo prediction intervals for the median number of protests in each Canadian province and territory. These projected increases in sales led to decreased predictions for the number of protests in each province, except for the two in our model with the largest positive parameter estimates, Ontario and Quebec.
Overall, using methods learned in STAT 413, we were able to come to interesting conclusions regarding Canadian protests.

\end{document}